-- creation of a Database for the day 20151101

create DATABASE IF NOT EXISTS db20151101;
USE db20151101;

-- Creation of the table catalogue and loading of the data

DROP TABLE IF EXISTS catalogue;
CREATE TABLE catalogue (ProductColorId INT, 
                      GenderLabel STRING,
                      SupplierColorLabel STRING, 
                      SeasonLabel STRING)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ';' 
STORED AS TEXTFILE
TBLPROPERTIES ("skip.header.line.count"="1");

LOAD DATA INPATH "/user/hue/data_tool/Catalogue_20151101.csv" OVERWRITE INTO TABLE catalogue;

-- Creation of the table customer
DROP TABLE IF EXISTS customer;

CREATE TABLE customer (CustomerId INT,
                       DomainCode STRING,
                       BirthDate DATE,
                       Gender STRING,
                       Size int)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ';' 
STORED AS TEXTFILE
TBLPROPERTIES ("skip.header.line.count"="1");

LOAD DATA INPATH "/user/hue/data_tool/Customer_20151101.csv" OVERWRITE INTO TABLE customer;

-- Creation of the table order
DROP TABLE IF EXISTS order1;

CREATE TABLE order1 (OrderNumber int,
                    VariantId int, 
                    CustomerId int,
                    Quantity int,
                    UnitPrice int,
                    OrderCreationDate Date)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ';' 
STORED AS TEXTFILE
TBLPROPERTIES ("skip.header.line.count"="1");

LOAD DATA INPATH "/user/hue/data_tool/Order_20151101.csv" OVERWRITE INTO TABLE order1;

-- Creation of the table reference

DROP TABLE IF EXISTS reference;

CREATE TABLE reference (VariantId int,
                    ProductColorId int,
                    ProductId int)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ';' 
STORED AS TEXTFILE
TBLPROPERTIES ("skip.header.line.count"="1");

LOAD DATA INPATH "/user/hue/data_tool/Product_Reference_20151101.csv" OVERWRITE INTO TABLE reference;


-- Create the data variant

VariantId	MinSize	MaxSize	Size

DROP TABLE IF EXISTS variant;

CREATE TABLE variant (VariantId int,
                      MinSize int,	MaxSize int,
                      Size String)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ';' 
STORED AS TEXTFILE
TBLPROPERTIES ("skip.header.line.count"="1");

LOAD DATA INPATH "/user/hue/data_tool/Variant.csv" OVERWRITE INTO TABLE variant;



--------------------------------------------------------------------  Table queries 

-- Creation of the table productreference

DROP TABLE IF EXISTS productreference;
create table ProductReference as SELECT variantid, productcolorid FROM reference ;

-- Creation of the table customerdescription

DROP TABLE IF EXISTS customerdescription;
create table customerdescription as 
	SELECT customerid as userid, gender, size, domaincode
	FROM customer;

-- Creation of the table productdescription

DROP TABLE IF EXISTS productdescription;
CREATE TABLE productdescription AS 
	SELECT productcolorid, genderlabel as gender, suppliercolorlabel as color
	FROM catalogue;

-- Creation of the table purchase description from the provide datasets

DROP TABLE IF EXISTS purchasedescription;
CREATE TABLE purchasedescription AS 
	SELECT a.customerid AS userid, 
		   b.productid AS productid, 
		   ordercreationdate AS purchasedatetime, 
		   quantity,
		   unitprice
	FROM order1 AS a 
	JOIN reference AS b 
	ON (a.variantid=b.variantid);








-------------------------------------------------------------------------- the query for aggregate the table product
DROP TABLE IF EXISTS prodagg;
CREATE TABLE prodagg AS
	SELECT productid, SUM(quantity*unitprice) AS totalAmount, 
	   SUM(quantity) AS totalquantity, COUNT(DISTINCT userid) AS DistinctUserNB

	FROM purchasedescription
	GROUP BY productid;

-----#### not working for aggregate table customer I"m still working on it

select userid, purchasedatetime, pd.gender as gender, v.size as size 
from purchasedescription as ph, productdescription as pd, reference as r, variant as v
where (ph.productid=r.productid and r.productcolorid=pd.productcolorid 
	   and r.variantid=v.variantid);
